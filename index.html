<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPF - Gestão de Pedidos Faturados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Paleta de Cores Personalizada: Tons de Verde e Branco com Degradê */
        :root {
            --green-main: #28a745; /* Verde principal */
            --green-dark: #1e7e34; /* Verde mais escuro para degradê */
            --green-light: #d4edda; /* Verde bem claro, quase branco */
            --text-dark: #333;
            --text-light: #f8f9fa; /* Branco para textos em fundos escuros */
        }

        body {
            background-color: #f0f2f5; /* Fundo cinza claro para destacar os cartões brancos */
        }

        .card {
            border: none; /* Remove bordas padrão */
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.08); /* Sombra suave */
        }

        .card-header {
            color: var(--text-light);
            /* Degradê para os cabeçalhos dos cartões */
            background: linear-gradient(to right, var(--green-main), var(--green-dark));
            border-bottom: none; /* Remove a linha da borda inferior */
            padding: 1rem 1.25rem;
        }
        
        /* Cabeçalho do card de "Novo Pedido" */
        .card-header.bg-light {
            background: #f8f9fa; /* Mantém o fundo claro */
            color: var(--text-dark);
            border-bottom: 1px solid rgba(0,0,0,.125); /* Volta a borda inferior para separação */
        }

        .text-primary { /* Altera a cor do H1 principal para o verde */
            color: var(--green-main) !important;
        }

        .status-nao-processado { 
            background-color: #ffc107; /* Amarelo para não processado */
            color: var(--text-dark); 
            font-weight: bold; 
        }
        .status-processado { 
            background-color: var(--green-main); /* Verde principal para processado */
            color: white; 
            font-weight: bold; 
        }
        
        /* Botões */
        .btn-primary { /* Botão "Salvar Pedido" */
            background: linear-gradient(to right, var(--green-main), var(--green-dark));
            border: none;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background: linear-gradient(to left, var(--green-main), var(--green-dark));
            box-shadow: 0 0.2rem 0.5rem rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .btn-success { /* Botão "Processar" na tabela */
            background-color: var(--green-main); 
            border-color: var(--green-main); 
            color: white;
        }
        .btn-success:hover {
            background-color: var(--green-dark);
            border-color: var(--green-dark);
        }

        /* Ajustes para botões info e danger para harmonizar */
        .btn-info {
            background-color: #17a2b8; /* Azul padrão */
            border-color: #17a2b8;
        }
        .btn-info:hover {
             background-color: #138496;
             border-color: #117a8b;
        }
        .btn-danger {
            background-color: #dc3545; /* Vermelho padrão */
            border-color: #dc3545;
        }
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        /* Estilo para os inputs de filtro */
        .form-control::placeholder {
            color: #a0a0a0;
        }
        
        /* Otimização Específica para Mobile */
        /* Reduz o padding dos botões de ação em telas pequenas */
        @media (max-width: 768px) {
            .table tbody td button {
                padding: 0.25rem 0.5rem; /* Botões menores */
                font-size: 0.75rem; /* Fonte menor */
                margin-bottom: 2px; /* Espaçamento entre botões */
            }
            /* Garante que os botões se alinhem verticalmente se houver pouco espaço */
            .table td:last-child {
                 white-space: nowrap; /* Impede que a coluna de botões quebre */
            }
        }
    </style>
</head>
<body>

    <div class="container mt-5">
        <h1 class="mb-4 text-primary">GPF - Gestão de Pedidos Faturados</h1>
        
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5>Novo Pedido</h5>
            </div>
            <div class="card-body">
                <form id="form-pedido">
                    <div class="mb-3">
                        <label for="pedido-input" class="form-label">Número do Pedido (8 dígitos)</label>
                        <input type="text" class="form-control" id="pedido-input" placeholder="Ex: 12345678" maxlength="8" pattern="\d{8}" title="Deve conter 8 dígitos" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="cliente-input" class="form-label">Número do Cliente</label>
                        <input type="text" class="form-control" id="cliente-input" placeholder="Ex: 9999" required>
                    </div>

                    <div class="mb-3">
                        <label for="endereco-input" class="form-label">Endereço (Formato: A0X-0Y-0Z)</label>
                        <input type="text" class="form-control" id="endereco-input" placeholder="Ex: A01-03-02" maxlength="9" required>
                        <div class="text-info small mt-1">
                            Valores permitidos: **X** (1-4), **Y** (0-3), **Z** (**1-2**).
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="descricao-input" class="form-label">Descrição do Pedido</label>
                        <input type="text" class="form-control" id="descricao-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary" id="btn-salvar">Salvar Pedido</button>
                </form>
            </div>
        </div>

        <div class="card mb-5">
            <div class="card-header">
                <h5>1. Lista de Pedidos Ativos</h5>
            </div>
            <div class="card-body">
                
                <div class="row mb-4 g-2">
                    <div class="col-12 col-md-4">
                        <input type="text" class="form-control" id="filtro-pedido" placeholder="Filtrar por # Pedido">
                    </div>
                    <div class="col-12 col-md-4">
                        <input type="text" class="form-control" id="filtro-endereco" placeholder="Filtrar por Endereço">
                    </div>
                    <div class="col-12 col-md-4">
                        <input type="text" class="form-control" id="filtro-cliente" placeholder="Filtrar por # Cliente">
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th># Pedido / Descrição</th>
                                <th># Cliente</th>
                                <th>Endereço</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="pedidos-tabela-corpo">
                            </tbody>
                    </table>
                </div>
                <p id="sem-pedidos" class="text-center text-muted mt-3" style="display:none;">Nenhum pedido ativo encontrado.</p>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-secondary">
                <h5>2. Histórico de Movimentações</h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Os filtros acima se aplicam a esta tabela também.</p>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th># Pedido</th>
                                <th>Ação</th>
                                <th>De</th>
                                <th>Para</th>
                                <th>Detalhes</th>
                            </tr>
                        </thead>
                        <tbody id="historico-tabela-corpo">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- FUNÇÕES DE VALIDAÇÃO CRÍTICA ---
        
        function validarEndereco(endereco) {
            // Validação de Endereço com Z entre 1 e 2
            const regex = /^A0[1-4]-0[0-3]-0[12]$/i;
            
            if (!regex.test(endereco)) {
                return false;
            }

            if (endereco.length !== 9) return false;

            return true;
        }

        function validarNumeroPedido(numero) {
            return /^\d{8}$/.test(numero); 
        }
        
        // --- LÓGICA DE SIMULAÇÃO DE BACKEND ---
        
        let pedidos = JSON.parse(localStorage.getItem('pedidos')) || [];
        let historico = JSON.parse(localStorage.getItem('historico')) || [];

        function salvarDados() {
            localStorage.setItem('pedidos', JSON.stringify(pedidos));
            localStorage.setItem('historico', JSON.stringify(historico));
        }

        function getPedido(id) {
            return pedidos.find(p => p.id === id);
        }

        function registrarHistorico(pedidoId, acao, enderecoAntigo = null, enderecoNovo = null, detalhes = '', pedido_info = null) {
            
            let info = pedido_info || getPedido(pedidoId); 
            
            if (!info) {
                const ultimoRegistro = historico.find(r => r.id_pedido === pedidoId) || {};
                info = {
                    numero_pedido: ultimoRegistro.numero_pedido || 'N/A',
                    numero_cliente: ultimoRegistro.numero_cliente || 'N/A',
                };
            }

            const registro = {
                id: Date.now() + Math.random(), 
                id_pedido: pedidoId,
                numero_pedido: info.numero_pedido || 'N/A', 
                numero_cliente: info.numero_cliente || 'N/A',
                acao: acao,
                endereco_antigo: enderecoAntigo || '-', 
                endereco_novo: enderecoNovo || '-',
                detalhes: detalhes,
                data_registro: new Date().toLocaleString('pt-BR')
            };
            historico.unshift(registro); 
            salvarDados();
            renderizarHistorico(); 
        }
        
        // --- FUNÇÕES DE RENDERIZAÇÃO E FILTRO ---

        function renderizarPedidos() {
            const corpo = document.getElementById('pedidos-tabela-corpo');
            corpo.innerHTML = '';
            
            const semPedidosMsg = document.getElementById('sem-pedidos');
            
            const filtroPedido = document.getElementById('filtro-pedido').value.toUpperCase();
            const filtroEndereco = document.getElementById('filtro-endereco').value.toUpperCase();
            const filtroCliente = document.getElementById('filtro-cliente').value.toUpperCase();

            const pedidosFiltrados = pedidos.filter(pedido => {
                const pedidoMatch = !filtroPedido || pedido.numero_pedido.includes(filtroPedido);
                const enderecoMatch = !filtroEndereco || pedido.endereco.includes(filtroEndereco);
                const clienteMatch = !filtroCliente || pedido.numero_cliente.toUpperCase().includes(filtroCliente);
                
                return pedidoMatch && enderecoMatch && clienteMatch;
            });

            const pedidosOrdenados = [...pedidosFiltrados].sort((a, b) => a.endereco.localeCompare(b.endereco));

            // Lógica para mostrar/esconder a mensagem
            if (pedidosOrdenados.length === 0) {
                if (semPedidosMsg) semPedidosMsg.style.display = 'block';
            } else {
                if (semPedidosMsg) semPedidosMsg.style.display = 'none';
            }

            pedidosOrdenados.forEach(pedido => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        ${pedido.numero_pedido}
                        <div class="text-muted small">${pedido.descricao}</div>
                    </td>
                    <td>${pedido.numero_cliente}</td>
                    <td>${pedido.endereco}</td>
                    <td><span class="badge ${pedido.status === 'processado' ? 'status-processado' : 'status-nao-processado'}">${pedido.status.toUpperCase().replace('_', ' ')}</span></td>
                    <td>
                        <button class="btn btn-sm btn-success processar-btn" data-id="${pedido.id}">Processar</button>
                        <button class="btn btn-sm btn-info mover-btn" data-id="${pedido.id}">Mover</button>
                        <button class="btn btn-sm btn-danger excluir-btn" data-id="${pedido.id}">Excluir</button>
                    </td>
                `;
                corpo.appendChild(tr);
            });
        }
        
        function renderizarHistorico() {
            const corpo = document.getElementById('historico-tabela-corpo');
            corpo.innerHTML = '';
            
            const filtroPedido = document.getElementById('filtro-pedido').value.toUpperCase();
            const filtroEndereco = document.getElementById('filtro-endereco').value.toUpperCase();
            const filtroCliente = document.getElementById('filtro-cliente').value.toUpperCase();

            const historicoFiltrado = historico.filter(registro => {
                const pedidoMatch = !filtroPedido || registro.numero_pedido.includes(filtroPedido);
                const enderecoMatch = !filtroEndereco || (registro.endereco_novo.includes(filtroEndereco)) || (registro.endereco_antigo.includes(filtroEndereco));
                const clienteMatch = !filtroCliente || registro.numero_cliente.includes(filtroCliente);
                
                return pedidoMatch && enderecoMatch && clienteMatch;
            });

            historicoFiltrado.forEach(registro => {
                
                let displayDe = registro.endereco_antigo;
                let displayPara = registro.endereco_novo;

                if (registro.acao === 'Criado') {
                    displayDe = '-'; 
                } 
                else if (registro.acao === 'Status Alterado') { 
                    displayDe = registro.endereco_antigo;
                    displayPara = 'PROCESSADO'; 
                } 
                else if (registro.acao === 'Excluído') {
                    displayPara = '-'; 
                } 

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${registro.data_registro}</td>
                    <td>${registro.numero_pedido}</td>
                    <td><strong>${registro.acao}</strong></td>
                    <td>${displayDe}</td>
                    <td>${displayPara}</td>
                    <td>${registro.detalhes}</td>
                `;
                corpo.appendChild(tr);
            });
        }
        
        // --- MANIPULADORES DE EVENTOS ---
        
        document.getElementById('filtro-pedido').addEventListener('input', () => { renderizarPedidos(); renderizarHistorico(); });
        document.getElementById('filtro-endereco').addEventListener('input', () => { renderizarPedidos(); renderizarHistorico(); });
        document.getElementById('filtro-cliente').addEventListener('input', () => { renderizarPedidos(); renderizarHistorico(); });


        document.getElementById('endereco-input').addEventListener('input', function() {
            let input = this;
            let value = input.value.toUpperCase().replace(/-/g, '');
            
            value = value.substring(0, 7);

            let formattedValue = '';
            if (value.length > 0) {
                formattedValue += value.substring(0, 3);
            }
            if (value.length > 3) {
                formattedValue += '-';
                formattedValue += value.substring(3, 5);
            }
            if (value.length > 5) {
                formattedValue += '-';
                formattedValue += value.substring(5, 7);
            }
            
            input.value = formattedValue;
        });


        document.getElementById('form-pedido').addEventListener('submit', function(e) {
            e.preventDefault();
            const enderecoInput = document.getElementById('endereco-input');
            const pedidoInput = document.getElementById('pedido-input');
            const clienteInput = document.getElementById('cliente-input');
            const descricaoInput = document.getElementById('descricao-input');

            const endereco = enderecoInput.value.toUpperCase();
            const numeroPedido = pedidoInput.value;
            const numeroCliente = clienteInput.value.toUpperCase();

            // 1. Validação CRÍTICA do Endereço Logístico
            if (!validarEndereco(endereco)) {
                alert("ERRO: O endereço não está no formato A0X-0Y-0Z OU os valores estão fora do intervalo (X:1-4, Y:0-3, Z:1-2).");
                enderecoInput.focus();
                return;
            }

            // 2. Validação do Número do Pedido
            if (!validarNumeroPedido(numeroPedido)) {
                 alert("O Número do Pedido deve ter exatamente 8 dígitos numéricos.");
                 return;
            }
            
            // 3. Checagem de Unicidade do Pedido (mantida)
            if (pedidos.some(p => p.numero_pedido === numeroPedido)) {
                alert(`O Número de Pedido ${numeroPedido} já existe.`);
                return;
            }
            
            // 4. CONSTRUÇÃO E EXIBIÇÃO DA CONFIRMAÇÃO
            const mensagemConfirmacao = 
                `CONFIRMA SALVAMENTO? \n\n` +
                `Pedido: ${numeroPedido}\n` +
                `Cliente: ${numeroCliente}\n` +
                `Endereço: ${endereco}\n\n` +
                `Descrição: ${descricaoInput.value.substring(0, 50)}...`;

            if (!confirm(mensagemConfirmacao)) {
                return; // Aborta se o usuário clicar em Cancelar
            }

            const novoPedido = {
                id: Date.now(),
                numero_pedido: numeroPedido,
                numero_cliente: numeroCliente,
                endereco: endereco,
                descricao: descricaoInput.value,
                status: 'nao_processado',
                data_criacao: new Date().toLocaleString('pt-BR')
            };

            pedidos.push(novoPedido);
            salvarDados(); 
            // Passando 'novoPedido' como 'pedido_info'
            registrarHistorico(novoPedido.id, 'Criado', null, novoPedido.endereco, `Pedido criado.`, novoPedido);
            
            renderizarPedidos();
            this.reset();
        });

        document.getElementById('pedidos-tabela-corpo').addEventListener('click', function(e) {
            const target = e.target;
            const id = parseInt(target.getAttribute('data-id'));
            const pedidoIndex = pedidos.findIndex(p => p.id === id);
            
            if (pedidoIndex === -1) return;
            let pedido = pedidos[pedidoIndex];

            // AÇÃO PROCESSAR (MODIFICADA: Remove o pedido após o processamento)
            if (target.classList.contains('processar-btn')) {
                if (!confirm(`Tem certeza que deseja PROCESSAR e REMOVER o Pedido ${pedido.numero_pedido} da lista de ativos?`)) {
                    return; 
                }

                if (pedido.status === 'nao_processado') {
                    
                    // 1. Clonar o pedido e definir o status como processado (para o histórico)
                    let pedidoProcessado = {...pedido, status: 'processado'};
                    
                    // 2. Registrar histórico (antes de remover do array 'pedidos')
                    registrarHistorico(id, 'Status Alterado', pedido.endereco, pedido.endereco, `Status alterado para Processado e removido da lista ativa.`, pedidoProcessado);

                    // 3. REMOÇÃO DA LISTA ATIVA
                    pedidos.splice(pedidoIndex, 1);
                    
                    // 4. Salvar e renderizar
                    salvarDados();
                    renderizarPedidos();
                }
            } 
            // AÇÃO EXCLUIR
            else if (target.classList.contains('excluir-btn')) {
                if (!confirm(`CONFIRMA EXCLUSÃO? O Pedido ${pedido.numero_pedido} será permanentemente removido.`)) {
                    return; 
                }
                
                // Passando 'pedido' como 'pedido_info' antes de removê-lo
                registrarHistorico(id, 'Excluído', pedido.endereco, null, `Pedido removido do sistema.`, pedido);
                pedidos.splice(pedidoIndex, 1);
                salvarDados();
                renderizarPedidos();
            }
            // AÇÃO MOVER
            else if (target.classList.contains('mover-btn')) {
                
                if (!confirm(`CONFIRMA MOVIMENTAÇÃO? Você será solicitado a informar o novo endereço para o Pedido ${pedido.numero_pedido}.`)) {
                    return; 
                }

                const novoEnderecoPrompt = prompt(`Mover pedido ${pedido.numero_pedido} de ${pedido.endereco} para qual novo endereço (Formato A0X-0Y-0Z)?`);
                
                if (novoEnderecoPrompt) {
                    const enderecoUpperCase = novoEnderecoPrompt.toUpperCase();
                    
                    // Validação CRÍTICA no momento da movimentação (Z: 1-2)
                    if (!validarEndereco(enderecoUpperCase)) {
                        alert("ERRO: O endereço de destino não está no formato A0X-0Y-0Z OU os valores estão fora do intervalo (X:1-4, Y:0-3, Z:1-2). Movimentação cancelada.");
                        return;
                    }

                    if (pedido.endereco === enderecoUpperCase) {
                        alert("O novo endereço é igual ao atual. Movimentação cancelada.");
                        return;
                    }
                    
                    const enderecoAntigo = pedido.endereco;
                    pedido.endereco = enderecoUpperCase;
                    
                    // Passando 'pedido' como 'pedido_info'
                    registrarHistorico(id, 'Movido', enderecoAntigo, pedido.endereco, `Movido de ${enderecoAntigo} para ${pedido.endereco}`, pedido);
                    salvarDados();
                    renderizarPedidos();
                } else if (novoEnderecoPrompt === "") {
                     alert("Novo endereço não pode ser vazio. Movimentação cancelada.");
                }
            }
        });

        // Carregar as duas listas na inicialização
        renderizarPedidos();
        renderizarHistorico();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>